# HeyStat Nginx Configuration for Mac Mini M2
# This file should be included in the main nginx.conf

server {
    listen 8082;
    server_name heystat.truyenthong.edu.vn localhost;

    # Debug logging
    access_log /opt/homebrew/var/log/nginx/heystat_access.log;
    error_log /opt/homebrew/var/log/nginx/heystat_error.log warn;

    location / {
        # Simple proxy to HeyStat Docker container
        proxy_pass http://127.0.0.1:42337;
        
        # Timeouts for long-running connections
        proxy_read_timeout 86400;
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;

        # CRITICAL: Host header MUST match JAMOVI_HOST_A for multi-origin security
        proxy_set_header Host heystat.truyenthong.edu.vn:42337;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        
        # CRITICAL FIX: X-Forwarded-Host must NOT have port (browser sees :443)
        # X-Forwarded-Proto must be https (Cloudflare terminates SSL)
        # This makes server return URLs like https://heystat.truyenthong.edu.vn/
        proxy_set_header X-Forwarded-Proto https;
        proxy_set_header X-Forwarded-Host heystat.truyenthong.edu.vn;

        # WebSocket support - use mapped variable
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
        
        # Forward WebSocket headers
        proxy_set_header Sec-WebSocket-Key $http_sec_websocket_key;
        proxy_set_header Sec-WebSocket-Version $http_sec_websocket_version;
        proxy_set_header Sec-WebSocket-Extensions $http_sec_websocket_extensions;
        proxy_set_header Sec-WebSocket-Protocol $http_sec_websocket_protocol;
        
        # Origin from client
        proxy_set_header Origin $http_origin;
        
        # Forward cookies
        proxy_set_header Cookie $http_cookie;
        
        # Disable ALL buffering for WebSocket
        proxy_buffering off;
        proxy_cache off;
        proxy_cache_bypass $http_upgrade;
        proxy_no_cache 1;
        
        # Reduce latency
        tcp_nodelay on;
        keepalive_timeout 65;
    }
}
