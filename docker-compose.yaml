services:
  jamovi-deps:
    image: jamovi/jamovi-deps:2.7.11
    build:
      context: .
      dockerfile: docker/deps-Dockerfile
    profiles:
      - donotstart

  # vite:
  #   image: jonathonlove/vite:latest
  #   container_name: vite
  #   privileged: true
  #   command: [ 'mkdir -p /source/merged && unionfs-fuse -o cow /source/server:/source/client=RW /source/merged && cd /source/merged && echo installing npm deps && npm install && echo starting vite server && vite --host' ]
  #   volumes:
  #     - './client/main:/source/client/main'
  #     - './client/resultsview:/source/client/resultsview'
  #     - './client/analysisui:/source/client/analysisui'
  #     - './client/lib:/source/client/lib'
  #     - './client/assets:/source/client/assets'
  #     - './client/common:/source/client/common'
  #     - './client/index.html:/source/client/index.html'
  #     - './client/resultsview.html:/source/client/resultsview.html'
  #     - './client/analysisui.html:/source/client/analysisui.html'
  #     - './client/tsconfig.json:/source/client/tsconfig.json'
  #     - './client/vite.config.mts:/source/client/vite.config.mts'
  #     - './client/package.json:/source/client/package.json'
  #     - './server/jamovi/server/jamovi.proto:/source/server/assets/coms.proto'
  #   ports:
  #     - '5173:5173'
  #     - '24678:24678'

  heystat:
    image: heystat/heystat:2.7.6
    container_name: heystat
    build:
      context: .
      dockerfile: docker/jamovi-Dockerfile
    platform: linux/arm64
    ports:
      - '42337:42337'
      - '42338:42338'
      - '42339:42339'
    command: ["/usr/bin/python3 -u -m jamovi.server 42337 --if=*"]
    stdin_open: true
    # Stop grace period must be an integer duration supported by the Docker API.
    # Using a fractional value (e.g. 0.1s) causes an error in some compose/engine
    # implementations: `cannot unmarshal number 0.1 into Go struct field CreateRequest.StopTimeout of type int`.
    # Use 1s (one second) or an integer number of seconds instead.
    stop_grace_period: 1s
    environment:

        # for development, use the vite dev server
        # (uncomment/enable the vite service above too)
        # JAMOVI_DEV_SERVER: "http://vite:5173"

        # block Rj - don't enable unless you understand the risks!
        JAMOVI_ALLOW_ARBITRARY_CODE: 'false'

        # for security, HeyStat runs across 3 origins
        #
        # Using path-based separation for single domain setup
        # Port changed to 42337 to avoid conflict with other services
        JAMOVI_HOST_A: 'heystat.truyenthong.edu.vn:42337'
        JAMOVI_HOST_B: 'heystat.truyenthong.edu.vn:42337/analyses'
        JAMOVI_HOST_C: 'heystat.truyenthong.edu.vn:42337/results'

        # separate by host (RECOMMENDED)
        # JAMOVI_HOST_A: 'jamovi.127.0.0.1.nip.io:41337'
        # JAMOVI_HOST_B: 'a.jamovi.127.0.0.1.nip.io:41337'
        # JAMOVI_HOST_C: 'r.jamovi.127.0.0.1.nip.io:41337'

        # separate by path (NOT RECOMMENDED! REDUCES SECURITY!)
        # JAMOVI_HOST_A: 'jamovi.127.0.0.1.nip.io:41337'
        # JAMOVI_HOST_B: 'jamovi.127.0.0.1.nip.io:41337/analyses'
        # JAMOVI_HOST_C: 'jamovi.127.0.0.1.nip.io:41337/results'

        # prevent unauthorized access
        # Let Jamovi auto-generate access key on first access
        # Set a stable access key for automated testing. Use a secret in production.
        # JAMOVI_ACCESS_KEY: 'your-secret-key-here'
        # then access jamovi with ?access_key=yourpasswordhere added to the url
        # i.e. 127.0.0.1:41337/?access_key=yourpasswordhere
        # or alternatively, remove the password requirement:
        JAMOVI_ACCESS_KEY: ''
        # Or set JAMOVI_DISABLE_ACCESS_KEY=1 (or true) to explicitly disable
        # access-key enforcement without changing the configured value. This is
        # handy for local testing but SHOULD NOT be used in production.
        # JAMOVI_DISABLE_ACCESS_KEY: '1'

    volumes:
      - ./Documents:/root/Documents
      - ./jamovi-modules:/root/.jamovi/modules
      # Mount fixed public_roots.py
      - ./server/jamovi/server/public_roots.py:/usr/lib/jamovi/server/jamovi/server/public_roots.py:ro
      # Mount built client files to override container's default client
      - ./client/dist:/usr/lib/jamovi/client:ro
